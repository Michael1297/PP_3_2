<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Admin panel</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

</head>
<body>
    <!-- Заголовок окна -->
    <div class="container-fluid" th:object = "${admin}">
        <dl class="row p-2 bg-dark">
            <div class="col-11 text-left">
                <span class="text-white" style="font-size: large">
                    <strong><a th:text="*{email}"></a></strong>
                    with roles:
                    <a th:text="${#strings.setJoin(admin.roles, ' ')}"></a>
                </span>
            </div>
            <form id="logout-form" th:action= "@{/logout}" method="POST">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class = "btn btn-link" style="color: darkgray">Logout</button>
            </form>
        </dl>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Age</th>
                <th>Email</th>
                <th>Role</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            <!-- Вывод пользователей -->
            <tr th:each="user:${usersList}">
                <td th:text="${user.id}"></td>
                <td th:text="${user.firstName}"></td>
                <td th:text="${user.lastName}"></td>
                <td th:text="${user.age}"></td>
                <td th:text="${user.email}"></td>
                <td th:text="${#strings.setJoin(user.roles, ' ')}"></td>
                <td><button class = "btn update btn-primary" th:data-user="${user}">Update</button></td>
                <td><a th:href = "@{./remove/{id}(id=${user.id})}" class = "btn btn-danger">Remove</a></td>
            </tr>

            <!-- Добавления пользователя в таблицу -->
            <tr>
                <td>
                    <a th:href = "@{./create/}" class = "btn btn-primary">Create</a>
                </td>
            </tr>
        </tbody>
    </table>

    <div id="updateModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    <input th:name="${_csrf.parameterName}" type="hidden" th:value="${_csrf.token}" />

                    <div class ="form-group">
                        <label> User Id </label>
                        <label>
                            <input
                                    disabled type = "number"
                                    name = "id"
                                    class = "form-control"
                                    placeholder="User Id"
                            />
                        </label>
                    </div>

                    <div class ="form-group">
                        <label> User First Name </label>
                        <label>
                            <input
                                    type = "text"
                                    name = "firstName"
                                    class = "form-control"
                                    placeholder="Enter User First Name"
                            />
                        </label>
                        <!-- <div style="color: red" th:if="${#fields.hasErrors('firstName')}" th:errors="firstName">First Name Error</div> -->
                    </div>

                    <div class ="form-group">
                        <label> User Last Name </label>
                        <label>
                            <input
                                    type = "text"
                                    name = "lastName"
                                    class = "form-control"
                                    placeholder="Enter User Last Name"
                            />
                        </label>
                        <!-- <div style="color: red" th:if="${#fields.hasErrors('lastName')}" th:errors="lastName">Last Name Error</div> -->
                    </div>

                    <div class ="form-group">
                        <label> User Age </label>
                        <label>
                            <input
                                    type = "number"
                                    name = "age"
                                    class = "form-control"
                                    placeholder="Enter User Age"
                                    min="0"
                            />
                        </label>
                        <!-- <div style="color: red" th:if="${#fields.hasErrors('age')}" th:errors="age">Age Error</div> -->
                    </div>

                    <div class ="form-group">
                        <label> User Email </label>
                        <label>
                            <input
                                    type = "text"
                                    name = "email"
                                    class = "form-control"
                                    placeholder="Enter User Email"
                            />
                        </label>
                        <!-- <div style="color: red" th:if="${#fields.hasErrors('email')}" th:errors="email">Email Error</div> -->
                    </div>

                    <div class ="form-group">
                        <label> User Password </label>
                        <label>
                            <input
                                    type = "password"
                                    name = "password"
                                    class = "form-control"
                                    placeholder="Enter User Password"
                            />
                        </label>
                        <!-- <div style="color: red" th:if="${#fields.hasErrors('password')}" th:errors="password">Password Error</div> -->
                    </div>

                    <div class ="form-group">
                        <label for="roles">Role</label>
                        <select multiple class="form-control" id="roles" name="roles">
                            <option th:each="role: ${roles}"
                                    th:value="${role.id}"
                                    th:text="${role}">
                            </option>
                        </select>
                        <!-- <div style="color: red" th:if="${#fields.hasErrors('roles')}" th:errors="roles">Role Error</div> -->
                    </div>

                    <div class = "box-footer">
                        <button type="submit" class = "btn btn-success">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

    <script>
        $(function(){
            $("button.btn.update.btn-primary").click(function(){
                const $modal = $('#updateModal').clone();
                const $btn = $(this);
                const user = JSON.parse($btn.attr('data-user'));

                $modal.find('[name="id"]').val(user.id);
                $modal.find('[name="firstName"]').val(user.firstName);
                $modal.find('[name="lastName"]').val(user.lastName);
                $modal.find('[name="age"]').val(user.age);
                $modal.find('[name="email"]').val(user.email);
                $modal.find('[name="password"]').val(user.password);

                //сделать чтобы роли у пользователя были выбраны
                const roles = $modal.find('[name="roles"] > option');
                for (const role of roles) {
                    for (const userRole of user.roles) {
                        if (role.text === userRole.name.replace(/^ROLE_/, "")){
                            role.selected = true;
                        }
                    }
                }

                //указание ссылки на изменения данных при нажатии на кнопку
                $modal.find('form').attr('action', './edit/' + user.id);

                //show dialog
                $modal.modal();
            });
        });
    </script>

</body>
</html>